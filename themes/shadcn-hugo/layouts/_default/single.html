{{ define "main" }}
<div class="container relative py-10">
  <div class="mx-auto flex w-full flex-col gap-10 lg:flex-row">
    <!-- Main Content -->
    <article class="flex-1 min-w-0">
      <div class="space-y-4">
        <div class="flex items-center space-x-2 text-sm text-muted-foreground">
          <i class="fa-regular fa-calendar text-xs"></i>
          <time datetime="{{ .Date.Format "2006-01-02" }}">{{ .Date.Format "2006年01月02日" }}</time>
          {{ if .Params.categories }}
            <span>•</span>
            <i class="fa-regular fa-folder text-xs"></i>
            {{ range .Params.categories }}
              <a href="{{ "categories/" | relURL }}{{ . | urlize }}" class="hover:text-foreground transition-colors">{{ . }}</a>
            {{ end }}
          {{ end }}
          {{ if .Content }}
            <span>•</span>
            <i class="fa-regular fa-clock text-xs"></i>
            <span>{{ countwords .Plain }} 字</span>
          {{ end }}
        </div>
        <h1 class="inline-block font-extrabold tracking-tight text-4xl lg:text-5xl">{{ .Title }}</h1>
        {{ with .Params.description }}
          <p class="text-xl text-muted-foreground">{{ . }}</p>
        {{ end }}
      </div>

      {{ partial "ui/separator.html" (dict "class" "my-8") }}

      <div class="prose dark:prose-invert max-w-none article-content">
        {{ .Content }}
      </div>

      {{ partial "ui/separator.html" (dict "class" "my-8") }}

      {{ if .Params.tags }}
        <div class="flex flex-wrap gap-2">
          {{ range .Params.tags }}
            <a href="{{ "tags/" | relURL }}{{ . | urlize }}">
              {{ partial "ui/badge.html" (dict "text" . "variant" "secondary") }}
            </a>
          {{ end }}
        </div>
      {{ end }}

      {{ partial "giscus.html" . }}
    </article>

    <!-- Sidebar / TOC -->
    {{ if .TableOfContents }}
    <aside class="hidden w-[250px] shrink-0 lg:block">
      <div class="sticky top-20 flex flex-col max-h-[calc(100vh-6rem)]">
        <h4 class="text-sm font-semibold uppercase tracking-wider text-foreground/70 border-b pb-2 flex items-center gap-2 mb-4 shrink-0">
          <i class="fa-solid fa-list-ul text-xs"></i>
          目录
        </h4>
        <div class="toc text-sm text-muted-foreground overflow-y-auto pr-2 custom-scrollbar">
          {{ .TableOfContents }}
        </div>
      </div>
    </aside>
    {{ end }}
  </div>
</div>

<!-- 图片查看器模态框 -->
<div id="imageViewer" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/90 backdrop-blur-sm">
  <button id="closeViewer" class="absolute top-4 right-4 text-white hover:text-gray-300 transition-colors z-10">
    <i class="fas fa-times text-2xl"></i>
  </button>
  
  <button id="prevImage" class="absolute left-4 top-1/2 -translate-y-1/2 text-white hover:text-gray-300 transition-colors z-10">
    <i class="fas fa-chevron-left text-2xl"></i>
  </button>
  
  <button id="nextImage" class="absolute right-4 top-1/2 -translate-y-1/2 text-white hover:text-gray-300 transition-colors z-10">
    <i class="fas fa-chevron-right text-2xl"></i>
  </button>
  
  <button id="zoomIn" class="absolute bottom-4 left-4 text-white hover:text-gray-300 transition-colors z-10">
    <i class="fas fa-search-plus text-xl"></i>
  </button>
  
  <button id="zoomOut" class="absolute bottom-4 left-16 text-white hover:text-gray-300 transition-colors z-10">
    <i class="fas fa-search-minus text-xl"></i>
  </button>
  
  <button id="zoomReset" class="absolute bottom-4 left-28 text-white hover:text-gray-300 transition-colors z-10">
    <i class="fas fa-compress text-xl"></i>
  </button>
  
  <div class="relative max-w-[90vw] max-h-[90vh] overflow-hidden">
    <img id="viewerImage" src="" alt="" class="max-w-full max-h-full object-contain transition-transform duration-300">
  </div>
  
  <div class="absolute bottom-4 right-4 text-white text-sm">
    <span id="imageCounter"></span>
  </div>
</div>

<style>
  /* 文章内容样式 */
  .article-content {
    @apply leading-relaxed;
  }
  
  /* 图片样式 - 默认居中，上下间距 */
  .article-content img {
    @apply block mx-auto my-8 rounded-lg shadow-md cursor-pointer transition-all duration-200 hover:shadow-xl !important;
    max-width: 100%;
    height: auto;
    display: block !important;
    margin-left: auto !important;
    margin-right: auto !important;
  }
  
  /* 两个连续图片之间的更大间距 */
  .article-content img + img {
    margin-top: 2.5rem !important;
  }
  
  /* 代码块样式 */
  pre {
    @apply relative overflow-x-auto !m-0;
  }
  code {
    @apply font-mono text-sm leading-relaxed;
  }
  
  /* 图片查看器样式 */
  #imageViewer {
    @apply flex;
  }
  
  #imageViewer.hidden {
    @apply hidden;
  }
  
  /* 自定义滚动条 */
  .custom-scrollbar::-webkit-scrollbar {
    @apply w-2;
  }
  
  .custom-scrollbar::-webkit-scrollbar-track {
    @apply bg-transparent;
  }
  
  .custom-scrollbar::-webkit-scrollbar-thumb {
    @apply bg-gray-400 rounded-full;
  }
  
  .custom-scrollbar::-webkit-scrollbar-thumb:hover {
    @apply bg-gray-500;
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const imageViewer = document.getElementById('imageViewer');
  const viewerImage = document.getElementById('viewerImage');
  const imageCounter = document.getElementById('imageCounter');
  const closeBtn = document.getElementById('closeViewer');
  const prevBtn = document.getElementById('prevImage');
  const nextBtn = document.getElementById('nextImage');
  const zoomInBtn = document.getElementById('zoomIn');
  const zoomOutBtn = document.getElementById('zoomOut');
  const zoomResetBtn = document.getElementById('zoomReset');
  
  let currentImageIndex = 0;
  let images = [];
  let currentZoom = 1;
  
  // 获取文章中所有图片
  function getArticleImages() {
    const articleImages = document.querySelectorAll('.article-content img');
    images = Array.from(articleImages);
    return images;
  }
  
  // 打开图片查看器
  function openViewer(index) {
    images = getArticleImages();
    currentImageIndex = index;
    currentZoom = 1;
    
    if (images.length === 0) return;
    
    const img = images[currentImageIndex];
    viewerImage.src = img.src;
    viewerImage.alt = img.alt || '';
    updateImageCounter();
    resetZoom();
    
    imageViewer.classList.remove('hidden');
    imageViewer.classList.add('flex');
    document.body.style.overflow = 'hidden';
  }
  
  // 关闭图片查看器
  function closeViewer() {
    imageViewer.classList.add('hidden');
    imageViewer.classList.remove('flex');
    document.body.style.overflow = '';
    currentZoom = 1;
  }
  
  // 显示上一张图片
  function showPrevImage() {
    if (images.length === 0) return;
    currentImageIndex = (currentImageIndex - 1 + images.length) % images.length;
    updateViewerImage();
  }
  
  // 显示下一张图片
  function showNextImage() {
    if (images.length === 0) return;
    currentImageIndex = (currentImageIndex + 1) % images.length;
    updateViewerImage();
  }
  
  // 更新查看器中的图片
  function updateViewerImage() {
    const img = images[currentImageIndex];
    viewerImage.src = img.src;
    viewerImage.alt = img.alt || '';
    updateImageCounter();
    resetZoom();
  }
  
  // 更新图片计数器
  function updateImageCounter() {
    if (images.length > 1) {
      imageCounter.textContent = `${currentImageIndex + 1} / ${images.length}`;
    } else {
      imageCounter.textContent = '';
    }
  }
  
  // 放大
  function zoomIn() {
    currentZoom = Math.min(currentZoom + 0.2, 3);
    updateZoom();
  }
  
  // 缩小
  function zoomOut() {
    currentZoom = Math.max(currentZoom - 0.2, 0.5);
    updateZoom();
  }
  
  // 重置缩放
  function resetZoom() {
    currentZoom = 1;
    updateZoom();
  }
  
  // 更新缩放
  function updateZoom() {
    viewerImage.style.transform = `scale(${currentZoom})`;
  }
  
  // 为文章中的所有图片添加点击事件
  function addImageClickEvents() {
    const articleImages = document.querySelectorAll('.article-content img');
    articleImages.forEach((img, index) => {
      img.addEventListener('click', () => openViewer(index));
    });
  }
  
  // 事件监听器
  closeBtn.addEventListener('click', closeViewer);
  prevBtn.addEventListener('click', showPrevImage);
  nextBtn.addEventListener('click', showNextImage);
  zoomInBtn.addEventListener('click', zoomIn);
  zoomOutBtn.addEventListener('click', zoomOut);
  zoomResetBtn.addEventListener('click', resetZoom);
  
  // 点击背景关闭查看器
  imageViewer.addEventListener('click', function(e) {
    if (e.target === imageViewer) {
      closeViewer();
    }
  });
  
  // 键盘快捷键
  document.addEventListener('keydown', function(e) {
    if (imageViewer.classList.contains('hidden')) return;
    
    switch(e.key) {
      case 'Escape':
        closeViewer();
        break;
      case 'ArrowLeft':
        showPrevImage();
        break;
      case 'ArrowRight':
        showNextImage();
        break;
      case '+':
      case '=':
        zoomIn();
        break;
      case '-':
      case '_':
        zoomOut();
        break;
      case '0':
        resetZoom();
        break;
    }
  });
  
  // 滚轮缩放
  imageViewer.addEventListener('wheel', function(e) {
    if (e.ctrlKey || e.metaKey) {
      e.preventDefault();
      if (e.deltaY < 0) {
        zoomIn();
      } else {
        zoomOut();
      }
    }
  });
  
  // 初始化
  addImageClickEvents();
  
  // 监听内容变化（如果文章是动态加载的）
  const observer = new MutationObserver(function(mutations) {
    mutations.forEach(function(mutation) {
      if (mutation.type === 'childList') {
        addImageClickEvents();
      }
    });
  });
  
  const articleContent = document.querySelector('.article-content');
  if (articleContent) {
    observer.observe(articleContent, {
      childList: true,
      subtree: true
    });
  }
});
</script>
{{ end }}
